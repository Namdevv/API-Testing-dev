{% extends 'main/base.html' %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/process_bar.css' %}">
{% endblock %}

{% block title %}Select Sections{% endblock %}

{% block content %}
    <h1>Select Sections</h1>
    <div class="container-fluid mt-5">
        <b>Project: {{ project.project_name }}</b>
        <p>Document: {{ document.file.name|default:document.link }}</p>
    </div>

    <!-- Step Wizard -->
    <div class="container">
        <div class="steps-container mb-5">
            <ul class="steps">
                <li class="step completed">
                <div class="step-icon">1</div>
                <p>Upload / Review</p>
                </li>
                <li class="step completed">
                <div class="step-icon">2</div>
                <p>AI Extract</p>
                </li>
                <li class="step active">
                <div class="step-icon">3</div>
                <p>Choose Sections</p>
                </li>
                <li class="step">
                <div class="step-icon">4</div>
                <p>AI Test Case</p>
                </li>
                <li class="step">
                <div class="step-icon">5</div>
                <p>Report</p>
                </li>
            </ul>
        </div>
    </div>

    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìã Select Sections for Test Case Generation</h5>
            <div>
                <button class="btn btn-sm btn-outline-light me-2" onclick="selectAll()">Select All</button>
                <button class="btn btn-sm btn-outline-light" onclick="deselectAll()">Deselect All</button>
            </div>
        </div>
        <div class="card-body">
            {% if sections %}
                <form id="sectionForm">
                    {% csrf_token %}
                    <div class="row">
                        {% for section in sections %}
                        <div class="col-md-6 mb-3">
                            <div class="card section-card">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input section-checkbox" 
                                               type="checkbox" 
                                               value="{{ section.id }}" 
                                               id="section_{{ section.id }}"
                                               {% if section.is_selected %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="section_{{ section.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-2">
                                                        <span class="badge bg-{{ section.section_type|default:'secondary' }}">
                                                            {{ section.get_section_type_display }}
                                                        </span>
                                                        {{ section.section_title }}
                                                    </h6>
                                                    <p class="card-text text-muted small">
                                                        {{ section.section_content|truncatewords:20 }}
                                                    </p>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                    <h5 class="mt-3 text-muted">No sections found</h5>
                    <p class="text-muted">AI processing may not have extracted any sections from this document.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="phase-controls text-center mt-4">
        <a href="{% url 'project_detail_by_uuid' project_uuid=project.uuid %}" class="btn btn-secondary me-2">‚Üê Back</a>
        <button class="btn btn-primary" onclick="saveSelection()" {% if not sections %}disabled{% endif %}>
            Save Selection ‚Üí
        </button>
    </div>

    <script>
        function selectAll() {
            document.querySelectorAll('.section-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAll() {
            document.querySelectorAll('.section-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function saveSelection() {
            const selectedSections = Array.from(document.querySelectorAll('.section-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.value));
            
            fetch('{% url "update_section_selection" project_uuid=project.uuid %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    selected_sections: selectedSections
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Redirect to next step or back to project view
                    window.location.href = '{% url "project_detail_by_uuid" project_uuid=project.uuid %}';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving selection.');
            });
        }

        // Add click handler to section cards
        document.querySelectorAll('.section-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('.section-checkbox');
                    checkbox.checked = !checkbox.checked;
                }
            });
        });
    </script>

    <style>
        .section-card {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .section-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .section-checkbox:checked + label .section-card {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        
        .badge {
            font-size: 0.75em;
        }
    </style>
{% endblock %}
